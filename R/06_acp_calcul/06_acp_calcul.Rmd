---
title: "06_acp_calcul"
output: html_document
date: "2026-01-23"
---

##load data_standardise
```{r}
data_standardise<-read.csv("../../data/processed/credit_card_clean_standardised.csv")
```

### Diagonalisation de la matrice de corrélation

```{r}
# =================================================================
# ANALYSE EN COMPOSANTES PRINCIPALES (ACP) - VERSION SÉCURISÉE
# =================================================================

library(FactoMineR)
library(factoextra)

# 1. Calcul de l'ACP

res.pca <- PCA(data_standardise, scale.unit = TRUE, ncp = 2, graph = FALSE)

valeurs_propres <- get_eigenvalue(res.pca)

# 2. Affichage pour vérification
print("Résultat de la diagonalisation (Valeurs propres) :")
print(round(valeurs_propres, 3))

```

### Extraction des composantes principales

## Cercle des Corrélations

```{r}
# 1. On extrait les coordonnées des variables sur les axes conservés
# Cela s'appelle aussi les "chargements" (loadings)
var_extraction <- res.pca$var$coord

# 2. Affichage des contributions pour les 2 premières composantes
print("Coordonnées des variables sur les composantes extraites :")
print(round(var_extraction[, 1:2], 3))

# 3. Visualisation : Le Cercle des Corrélations
# C'est l'outil principal de l'étape d'extraction
fviz_pca_var(res.pca, 
             col.var = "contrib", # Couleur selon la contribution
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE) +
  labs(title = "Cercle des Corrélations - Composantes Extraites",
       x = "Dimension 1", y = "Dimension 2")
```


```{r}
# Extraire les coordonnées des individus sur les axes factoriels
# res.pca$ind$coord contient les scores
donnees_reduites <- as.data.frame(res.pca$ind$coord)

# Vérifier le nouveau dataset
print(donnees_reduites)
```

## matrice de correlation entre nos variables et les nouvelles axes

```{r}
write.csv(donnees_reduites, "../../data/processed/data_after_ACP.csv", row.names = FALSE)
print(res.pca$var$coord)
```

## L'inertie totale expliquée par les deux premiers axes
```{r}
# 1. On s'assure que eig.val est un data.frame
eig.val <- as.data.frame(get_eigenvalue(res.pca))

# 2. On récupère la valeur cumulée de la 2ème ligne (Dim 1 + Dim 2)
# On utilise les crochets [ligne, colonne] pour être 100% sûr
inertie_2_axes <- eig.val[2, "cumulative.variance.percent"]

# 3. Affichage propre
cat("L'inertie totale expliquée par les deux premiers axes est de :", 
    round(inertie_2_axes, 2), "%\n")
```

##Calcul des scores des individus
```{r}
# 1. Extraction des coordonnées des individus (les scores)
# On se limite aux axes conservés (ici Dim 1 et Dim 2)
scores_ind <- as.data.frame(res.pca$ind$coord[, 1:2])

# 2. Renommer les colonnes pour plus de clarté
colnames(scores_ind) <- c("Score_Depense", "Score_Tresorerie")

# 3. Aperçu des scores pour les 5 premiers clients
head(scores_ind)
```

## Contributions des variables
```{r}
# 1. Visualiser les contributions sur l'Axe 1
# fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)
fviz_contrib(res.pca, choice = "var", axes = 2, top = 10)
```

## Corrélations variables–composantes

```{r}
library(corrplot)
# res.pca est le résultat de ton ACP : PCA(data)
matrice_corr <- res.pca$var$cor

# Afficher les corrélations pour les 5 premiers axes
corrplot(matrice_corr, 
         method = "color",       # Remplit les carrés avec de la couleur
         type = "full",          # Affiche la matrice complète
         addCoef.col = "black",  # Affiche les coefficients de corrélation en noir
         tl.col = "black",       # Couleur des étiquettes (noms des variables)
         tl.srt = 45,            # Incline les noms des variables à 45 degrés
         diag = TRUE,            # Affiche la diagonale (toujours égale à 1)
         number.cex = 0.7,       # Taille des chiffres à l'intérieur
         col = colorRampPalette(c("blue", "white", "red"))(200), # Dégradé bleu-blanc-rouge
         title = "Corrélation entre les variables",
         mar = c(0,0,1,0))       # Ajuste les marges pour que le titre s'affiche
```